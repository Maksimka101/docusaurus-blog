"use strict";(self.webpackChunkdocusaurus_blog=self.webpackChunkdocusaurus_blog||[]).push([[64],{3905:(e,t,n)=>{n.d(t,{Zo:()=>m,kt:()=>d});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var r=a.createContext({}),u=function(e){var t=a.useContext(r),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},m=function(e){var t=u(e.components);return a.createElement(r.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,l=e.originalType,r=e.parentName,m=s(e,["components","mdxType","originalType","parentName"]),c=u(n),d=o,h=c["".concat(r,".").concat(d)]||c[d]||p[d]||l;return n?a.createElement(h,i(i({ref:t},m),{},{components:n})):a.createElement(h,i({ref:t},m))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var l=n.length,i=new Array(l);i[0]=c;var s={};for(var r in t)hasOwnProperty.call(t,r)&&(s[r]=t[r]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var u=2;u<l;u++)i[u]=n[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},4944:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>r,contentTitle:()=>i,default:()=>p,frontMatter:()=>l,metadata:()=>s,toc:()=>u});var a=n(7462),o=(n(7294),n(3905));const l={title:"Combine",date:"2022-09-4",tags:["dart","flutter","isolates","package"]},i=void 0,s={permalink:"/docusaurus-blog/blog/combine",editUrl:"https://github.com/Maksimka101/docusaurus-blog/tree/master/blog/combine/index.md",source:"@site/blog/combine/index.md",title:"Combine",description:"Combine logo",date:"2022-09-04T00:00:00.000Z",formattedDate:"September 4, 2022",tags:[{label:"dart",permalink:"/docusaurus-blog/blog/tags/dart"},{label:"flutter",permalink:"/docusaurus-blog/blog/tags/flutter"},{label:"isolates",permalink:"/docusaurus-blog/blog/tags/isolates"},{label:"package",permalink:"/docusaurus-blog/blog/tags/package"}],readingTime:5.99,hasTruncateMarker:!0,authors:[],frontMatter:{title:"Combine",date:"2022-09-4",tags:["dart","flutter","isolates","package"]},nextItem:{title:"Welcome",permalink:"/docusaurus-blog/blog/welcome"}},r={authorsImageUrls:[]},u=[{value:"Combine Isolate",id:"combine-isolate",level:3},{value:"Isolates pool",id:"isolates-pool",level:3},{value:"Method Channels",id:"method-channels",level:3},{value:"Closure variables",id:"closure-variables",level:3},{value:"Comparison",id:"comparison",level:2},{value:"Executor",id:"executor",level:3},{value:"Flutter isolate",id:"flutter-isolate",level:3}],m={toc:u};function p(e){let{components:t,...l}=e;return(0,o.kt)("wrapper",(0,a.Z)({},m,l,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"Combine logo",src:n(3866).Z,width:"548",height:"289"})),(0,o.kt)("p",null,"One of the keys to a successful application is performance. At the most time, it's fine to do everything\nin the main Isolate. However, sometimes you need to do some heavy task that may take significant time - 8\nor even 16 ms. In that case, you should create a new Isolate to perform a calculation in it. Dart's Isolates API\nis complicated. So it would be great to use a package that simplifies it. In pub dev, we have a lot of great\npackages for that and in this article I'll show one new and special -\n",(0,o.kt)("a",{parentName:"p",href:"https://pub.dev/packages/combine"},"Combine")),(0,o.kt)("details",null,(0,o.kt)("summary",null,"Haven't heard about isolate?"),(0,o.kt)("div",null,(0,o.kt)("p",null,"All Dart code runs inside of isolates. Each isolate has its own memory heap, ensuring that none of the state in an isolate is accessible from any other isolate."),"You can read about them in the ",(0,o.kt)("a",{href:"https://dart.dev/guides/language/concurrency#how-isolates-work"},"Dart documentation"),".")),(0,o.kt)("p",null,"The ",(0,o.kt)("strong",{parentName:"p"},"combine")," package is created to make it easier to use Isolate in these scenarios:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Create Isolate and communicate with it"),(0,o.kt)("li",{parentName:"ul"},"Efficiently execute tasks in the Isolates pool"),(0,o.kt)("li",{parentName:"ul"},"Use Method Channels in the Isolate"),(0,o.kt)("li",{parentName:"ul"},"Laziness. Nothing will be created until it's used"),(0,o.kt)("li",{parentName:"ul"},"The stub on the web platform")),(0,o.kt)("p",null,"Let's go through some items and compare Combine with Isolate!"),(0,o.kt)("h3",{id:"combine-isolate"},"Combine Isolate"),(0,o.kt)("p",null,"Everything you need is to call a ",(0,o.kt)("inlineCode",{parentName:"p"},"spawn")," method and pass ",(0,o.kt)("inlineCode",{parentName:"p"},"entryPoint")," function."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dart"},'final isolateInfo = await Combine().spawn((context) {\n  print("Argument from main isolate: ${context.argument}");\n\n  context.messenger.messages.listen((message) {\n    print("Message from main isolate: $message");\n  });\n}, argument: 42);\n\nisolateInfo.messenger\n  ..messages.listen((message) {\n    print("Message from isolate: $message");\n  })\n  ..send("Hello from main isolate!");\n')),(0,o.kt)("details",null,(0,o.kt)("summary",null,"The same using pure Isolate"),(0,o.kt)("div",null,(0,o.kt)("p",null,"This code is two times longer and more complicated."),(0,o.kt)("pre",{language:"dart"},"final port = ReceivePort();\n","await Isolate.spawn(\n","  (args) {\n",'    print("Argument from main isolate: ${args[1]}");\n',"\n","    final SendPort sendPort = values[0];\n","    final port = ReceivePort();\n","    sendPort.send(port.sendPort);\n","\n","    port.listen((message) {\n",'      print("Message from main isolate: $message");\n',"    });\n","  },\n","  [port.sendPort, 42],\n",");\n","\n","late final SendPort sendPort\n","port.listen((data) {\n","  if (data is SendPort) {\n","    sendPort = data;\n",'    sendPort.send("Hello from main isolate!");\n',"  } else {\n",'    print("Message from isolate: $data");\n',"  }\n","});\n"))),(0,o.kt)("p",null,"The spawn method returns ",(0,o.kt)("inlineCode",{parentName:"p"},"IsolateInfo")," which holds:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"IsolateMessenger")," to communicate with isolate. It has:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"messages")," getter which returns a stream of messages from the isolate"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"send")," method which sends a message to the isolate"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"CombineIsolate")," is a representation of isolate. It's used to kill isolate.")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"entryPoint")," function will be executed in the isolate.\nIt may be a static method or a top-level function as well as a class method or lambda function.\nIt even may use closure variables with some limitations.\nSee ",(0,o.kt)("a",{parentName:"p",href:"#closure-variables"},"the closure variables section")," for more info."),(0,o.kt)("p",null,"The entry point receives ",(0,o.kt)("inlineCode",{parentName:"p"},"context")," as an argument. Context is a holder for:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"argument")," parameter which was passed to the ",(0,o.kt)("inlineCode",{parentName:"li"},"spawn")," method"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"IsolateMessenger")," "),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"CombineIsolate"),". ")),(0,o.kt)("details",null,(0,o.kt)("summary",null,"The ",(0,o.kt)("code",null,"spawn")," method parameters."),(0,o.kt)("div",null,"This method takes a few parameters:",(0,o.kt)("ul",null,(0,o.kt)("li",null,(0,o.kt)("code",null,"entryPoint")," which was described above."),(0,o.kt)("li",null,"The ",(0,o.kt)("code",null,"argument")," parameter which will be accessible with ",(0,o.kt)("code",null,"context.argument")," from the entry point function"),(0,o.kt)("li",null,(0,o.kt)("code",null,"errorsAreFatal")," which specifies whether isolate should be killed on the uncaught exception."),(0,o.kt)("li",null,(0,o.kt)("code",null,"debugName")," is a name of the isolate which is visible in the editor.")))),(0,o.kt)("h3",{id:"isolates-pool"},"Isolates pool"),(0,o.kt)("p",null,"The most interesting part of this package is an Isolates pool which is named ",(0,o.kt)("inlineCode",{parentName:"p"},"CombineWorker"),".\nWith it, you can schedule the tasks which will be executed in the isolates pool. "),(0,o.kt)("p",null,"It's designed to be as safe and easy to use as possible. "),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"by default, you don't need to initialize the worker. It will be initialized while the first usage."),(0,o.kt)("li",{parentName:"ul"},"you can initialize the worker manually and without waiting for initialization to complete, start to schedule\nthe tasks. "),(0,o.kt)("li",{parentName:"ul"},"while initialization, you can specify the number of tasks per isolate using the tasksPerIsolate parameter.\nIf you want to execute asynchronous tasks which work with a file, network, or just an event loop, it will be\nmore efficient to run 2 or more tasks in the same isolate."),(0,o.kt)("li",{parentName:"ul"},"you can close the worker and cancel all the tasks or let them finish before closing."),(0,o.kt)("li",{parentName:"ul"},"exception in the task will be sent to the main isolate and thrown in it.\nFor example ",(0,o.kt)("inlineCode",{parentName:"li"},"final futureResult = CombineWorker().execute(() => throw IsolateException())"),".\nIn that case, ",(0,o.kt)("inlineCode",{parentName:"li"},"futureResult")," will be completed with ",(0,o.kt)("inlineCode",{parentName:"li"},"IsolateException"),".")),(0,o.kt)("p",null,"Small usage example from the documentation:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-dart"},'await CombineWorker().initialize();\n\nfinal helloWorld = await CombineWorker().execute(zeroArgsFunction);\nfinal maksim = await CombineWorker().executeWithArg(oneArgFunction, "Maksim");\nfinal helloArshak  = await CombineWorker().executeWith2Args(\n  twoArgsFunction, \n  "Hello", "Arshak!"\n);\n\nString zeroArgsFunction() => "Hello, World!";\nString oneArgFunction(String str) => str;\nString twoArgsFunction(String a, String b) => "$a, $b";\n')),(0,o.kt)("admonition",{type:"tip"},(0,o.kt)("p",{parentName:"admonition"},"Multiple ",(0,o.kt)("inlineCode",{parentName:"p"},"CombineWorker")," instances."),(0,o.kt)("p",{parentName:"admonition"},"Although it is a singleton you still can create a few instances of workers\nwith different configurations.\nCombine worker uses ",(0,o.kt)("inlineCode",{parentName:"p"},"CombineWorkerImpl")," under the hood which is not a singleton and\nnothing prevents you from using it.")),(0,o.kt)("h3",{id:"method-channels"},"Method Channels"),(0,o.kt)("p",null,"By default, you can't use Method Channels outside of the main Isolate. However, it's possible to use them in the\nCombine Isolate!"),(0,o.kt)("p",null,"It works because Combine overrides the default binary messenger and redirects messages to the main Isolate.\nSometimes it's not good for performance because this binary message will be copied twice. To send it\nto the main Isolate and the platform. So I recommend you to be careful when working with Method Channels."),(0,o.kt)("h3",{id:"closure-variables"},"Closure variables"),(0,o.kt)("p",null,"Isolate ",(0,o.kt)("inlineCode",{parentName:"p"},"entryPoint")," function for ",(0,o.kt)("inlineCode",{parentName:"p"},"spawn")," method or ",(0,o.kt)("inlineCode",{parentName:"p"},"task")," function for the ",(0,o.kt)("inlineCode",{parentName:"p"},"execute")," methods\nmay be a first-level, as well as a static or top-level."),(0,o.kt)("p",null,"Also, it may use closure variables but with some restrictions:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"closure variable will be copied (as every variable passed to isolate)\nso it won't be synchronized across Isolates."),(0,o.kt)("li",{parentName:"ul"},"if you use at least one variable from closure all closure variables\nwill be copied to the Isolate due to this ",(0,o.kt)("a",{parentName:"li",href:"https://github.com/dart-lang/sdk/issues/36983"},"issue"),".\nIt can lead to high memory consumption or event exception because\nsome variables may contain native resources.")),(0,o.kt)("p",null,"Due to the above points, I highly recommend you avoid using closure variables\nuntil this issue is fixed."),(0,o.kt)("h2",{id:"comparison"},"Comparison"),(0,o.kt)("p",null,"Each of these plugins is great however it's impossible to be perfect. So I'll try to show the weakness\nand strengths of Combine."),(0,o.kt)("h3",{id:"executor"},(0,o.kt)("a",{parentName:"h3",href:"https://pub.dev/packages/worker_manager"},"Executor")),(0,o.kt)("p",null,"Executor pros:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"It's mature"),(0,o.kt)("li",{parentName:"ul"},"The task can be canceled"),(0,o.kt)("li",{parentName:"ul"},"Task and isolate pool can be paused"),(0,o.kt)("li",{parentName:"ul"},"Doesn't depends on the flutter")),(0,o.kt)("p",null,"Combine pros:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Provides API for creating and working with isolate"),(0,o.kt)("li",{parentName:"ul"},"Allows to work with method channels"),(0,o.kt)("li",{parentName:"ul"},"Customizable. You can specify the number of parallel tasks per isolate and worker closing strategy.")),(0,o.kt)("h3",{id:"flutter-isolate"},(0,o.kt)("a",{parentName:"h3",href:"https://pub.dev/packages/flutter_isolate"},"Flutter isolate")),(0,o.kt)("p",null,"Flutter isolate pros:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"It's mature too"),(0,o.kt)("li",{parentName:"ul"},"It works with method channels in the much more efficient way")),(0,o.kt)("p",null,"Combine pros:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Easier to use"),(0,o.kt)("li",{parentName:"ul"},"It's possible to send non-primitive objects"),(0,o.kt)("li",{parentName:"ul"},"Doesn't starts a new Flutter engine"),(0,o.kt)("li",{parentName:"ul"},"Works on all Flutter platforms")),(0,o.kt)("p",null,"I suggest you use Flutter isolate only when your main goal is to work with method channels."),(0,o.kt)("hr",null),(0,o.kt)("p",null,"Thank you for reading this article. I hope it will help you write cool and performant applications\ud83d\udd25"))}p.isMDXComponent=!0},3866:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/combine_logo-ce76992f8a918aca91c2b570b2be8d4d.png"}}]);